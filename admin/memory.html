<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hAIveMind Admin - Memory Browser</title>
    <link rel="stylesheet" href="/admin/static/admin.css">
</head>
<body class="dashboard">
    <nav class="nav-header">
        <h1>üß† hAIveMind Admin</h1>
        <div class="nav-links">
            <a href="/admin/dashboard.html">Dashboard</a>
            <a href="/admin/memory.html" class="active">Memory Browser</a>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>

    <main class="main-content">
        <div class="card">
            <h2>üîç Memory Search</h2>
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="search-query">Search Query</label>
                    <input type="text" id="search-query" placeholder="Search memories..." style="width: 100%; padding: 10px;">
                </div>
                <div class="form-group">
                    <label for="search-category">Category</label>
                    <select id="search-category" style="width: 100%; padding: 10px;">
                        <option value="">All Categories</option>
                        <option value="global">Global</option>
                        <option value="project">Project</option>
                        <option value="conversation">Conversation</option>
                        <option value="agent">Agent</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="incidents">Incidents</option>
                        <option value="deployments">Deployments</option>
                        <option value="monitoring">Monitoring</option>
                        <option value="runbooks">Runbooks</option>
                        <option value="security">Security</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="searchMemories()" style="width: 100%;">üîç Search</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <label>
                    <input type="checkbox" id="semantic-search" checked> Semantic Search
                </label>
                <label>
                    <input type="checkbox" id="include-global" checked> Include Global
                </label>
                <label>
                    Limit: <input type="number" id="search-limit" value="20" min="1" max="100" style="width: 60px;">
                </label>
            </div>
        </div>

        <div class="card">
            <h2>üìä Memory Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-memories">-</div>
                    <div class="stat-label">Total Memories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="categories-count">-</div>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="machines-count">-</div>
                    <div class="stat-label">Contributing Machines</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="recent-memories">-</div>
                    <div class="stat-label">Added Today</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Search Results</h2>
            <div id="search-results">
                <p style="color: #666; text-align: center;">Enter a search query above to find memories</p>
            </div>
        </div>

        <div class="card">
            <h2>üìù Add New Memory</h2>
            <div class="form-group">
                <label for="memory-content">Content</label>
                <textarea id="memory-content" rows="4" style="width: 100%; padding: 10px;" placeholder="Enter memory content..."></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="memory-category">Category</label>
                    <select id="memory-category" style="width: 100%; padding: 10px;">
                        <option value="global">Global</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="incidents">Incidents</option>
                        <option value="monitoring">Monitoring</option>
                        <option value="runbooks">Runbooks</option>
                        <option value="security">Security</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="memory-context">Context (optional)</label>
                    <input type="text" id="memory-context" placeholder="Additional context..." style="width: 100%; padding: 10px;">
                </div>
                <div class="form-group">
                    <label for="memory-tags">Tags (comma-separated)</label>
                    <input type="text" id="memory-tags" placeholder="tag1, tag2, tag3" style="width: 100%; padding: 10px;">
                </div>
            </div>
            <button class="btn btn-success" onclick="addMemory()">üíæ Add Memory</button>
        </div>
    </main>

    <script src="/admin/static/admin.js"></script>
    <script>
        async function searchMemories() {
            const query = document.getElementById('search-query').value;
            const category = document.getElementById('search-category').value;
            const semantic = document.getElementById('semantic-search').checked;
            const includeGlobal = document.getElementById('include-global').checked;
            const limit = parseInt(document.getElementById('search-limit').value);

            if (!query.trim()) {
                showToast('Please enter a search query', 'error');
                return;
            }

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<p style="color: #666; text-align: center;">Searching...</p>';

            try {
                const params = new URLSearchParams({
                    query: query,
                    limit: limit,
                    semantic: semantic,
                    include_global: includeGlobal
                });

                if (category) params.append('category', category);

                const response = await authenticatedFetch(`/admin/api/memory/search?${params}`);
                
                if (response.ok) {
                    const memories = await response.json();
                    displaySearchResults(memories);
                } else {
                    resultsDiv.innerHTML = '<p style="color: #d63384;">Search failed</p>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<p style="color: #d63384;">Search error</p>';
            }
        }

        function displaySearchResults(memories) {
            const resultsDiv = document.getElementById('search-results');
            
            if (!memories || memories.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666; text-align: center;">No memories found</p>';
                return;
            }

            resultsDiv.innerHTML = memories.map(memory => `
                <div style="border: 1px solid #e1e5e9; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <span class="status online">${memory.category}</span>
                        <small style="color: #666;">${formatTime(memory.timestamp)}</small>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Content:</strong><br>
                        ${memory.content}
                    </div>
                    ${memory.context ? `<div style="margin-bottom: 10px;"><strong>Context:</strong> ${memory.context}</div>` : ''}
                    ${memory.tags && memory.tags.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <strong>Tags:</strong> ${memory.tags.map(tag => `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${tag}</span>`).join(' ')}
                        </div>
                    ` : ''}
                    <div style="font-size: 12px; color: #666;">
                        ID: ${memory.id} | Machine: ${memory.machine_id}
                        ${memory.similarity_score ? ` | Similarity: ${(memory.similarity_score * 100).toFixed(1)}%` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="editMemory('${memory.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteMemory('${memory.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addMemory() {
            const content = document.getElementById('memory-content').value;
            const category = document.getElementById('memory-category').value;
            const context = document.getElementById('memory-context').value;
            const tagsInput = document.getElementById('memory-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!content.trim()) {
                showToast('Please enter memory content', 'error');
                return;
            }

            try {
                const response = await authenticatedFetch('/admin/api/memory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        category: category,
                        context: context || null,
                        tags: tags.length > 0 ? tags : null
                    })
                });

                if (response.ok) {
                    showToast('Memory added successfully', 'success');
                    document.getElementById('memory-content').value = '';
                    document.getElementById('memory-context').value = '';
                    document.getElementById('memory-tags').value = '';
                    loadMemoryStats();
                } else {
                    showToast('Failed to add memory', 'error');
                }
            } catch (error) {
                showToast('Error adding memory', 'error');
            }
        }

        async function editMemory(memoryId) {
            // For simplicity, just show the memory ID for now
            // In a full implementation, this would open an edit dialog
            const newContent = prompt('Edit memory content (ID: ' + memoryId + '):');
            if (newContent) {
                try {
                    const response = await authenticatedFetch(`/admin/api/memory/${memoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newContent })
                    });

                    if (response.ok) {
                        showToast('Memory updated', 'success');
                        // Re-run last search if there was one
                        const query = document.getElementById('search-query').value;
                        if (query) searchMemories();
                    } else {
                        showToast('Failed to update memory', 'error');
                    }
                } catch (error) {
                    showToast('Error updating memory', 'error');
                }
            }
        }

        async function deleteMemory(memoryId) {
            if (!confirm('Delete this memory? This action cannot be undone.')) return;

            try {
                const response = await authenticatedFetch(`/admin/api/memory/${memoryId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Memory deleted', 'success');
                    // Re-run last search if there was one
                    const query = document.getElementById('search-query').value;
                    if (query) searchMemories();
                    loadMemoryStats();
                } else {
                    showToast('Failed to delete memory', 'error');
                }
            } catch (error) {
                showToast('Error deleting memory', 'error');
            }
        }

        async function loadMemoryStats() {
            try {
                const response = await authenticatedFetch('/admin/api/memory/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateMemoryStats(stats);
                }
            } catch (error) {
                console.error('Error loading memory stats:', error);
            }
        }

        function updateMemoryStats(stats) {
            document.getElementById('total-memories').textContent = stats.total_memories || 0;
            document.getElementById('categories-count').textContent = stats.categories_count || 0;
            document.getElementById('machines-count').textContent = stats.machines_count || 0;
            document.getElementById('recent-memories').textContent = stats.recent_memories || 0;
        }

        // Allow search on Enter key
        document.getElementById('search-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMemories();
            }
        });

        // Load initial stats
        loadMemoryStats();

        // Auto-refresh stats every 60 seconds
        setInterval(loadMemoryStats, 60000);
    </script>
</body>
</html>